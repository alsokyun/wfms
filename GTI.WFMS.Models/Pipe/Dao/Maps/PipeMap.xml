<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Main" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://ibatis.apache.org/mapping">
  <statements>

    <!--상수관로-->
    <select id ="SelectWtlPipeList" parameterClass="Hashtable" resultClass ="Hashtable">
      /* SelectWtlPipeList 상수관로 목록*/

      WITH C AS (
      SELECT COUNT(1) AS ROWCNT
      FROM INFOFMS.WTL_PIPE_LM A
        LEFT JOIN INFOFMS.V_FTR_CDE F ON A.FTR_CDE = F.FTR_CDE
        LEFT JOIN INFOFMS.BML_HADM_AS H ON A.HJD_CDE = H.HJD_CDE
        LEFT JOIN INFOUSER.CD_DTL_INFO C ON C.MST_CD = (SELECT MST_CD FROM INFOUSER.CD_MST_INFO WHERE ETC = 'MNG_CDE') AND C.DTL_CD = A.MNG_CDE
        LEFT JOIN INFOUSER.CD_DTL_INFO C2 ON C2.MST_CD = (SELECT MST_CD FROM INFOUSER.CD_MST_INFO WHERE ETC = 'JHT_CDE') AND C2.DTL_CD = A.JHT_CDE
        LEFT JOIN INFOUSER.CD_DTL_INFO C3 ON C3.MST_CD = '250102' AND C3.DTL_CD = A.MOP_CDE
      
      WHERE 1=1
      <isNotEmpty prepend="AND" property="MNG_CDE">
          A.MNG_CDE like #MNG_CDE# || '%'
        </isNotEmpty>

        <isNotEmpty prepend="AND" property="FTR_IDN">
          A.FTR_IDN like #FTR_IDN# || '%'
        </isNotEmpty>

        <isNotEmpty prepend="AND" property="HJD_CDE">
          A.HJD_CDE like #HJD_CDE# || '%'
        </isNotEmpty>

        <isNotEmpty prepend="AND" property="CNT_NUM">
          A.CNT_NUM like #CNT_NUM#  || '%'
        </isNotEmpty>

        <isNotEmpty prepend="AND" property="SHT_NUM">
          A.SHT_NUM like #SHT_NUM#  || '%'
        </isNotEmpty>

        <isNotEmpty prepend="AND" property="IST_YMD_FROM">
          A.IST_YMD <![CDATA[>=]]> decode(length(#IST_YMD_FROM#), 10, to_char(to_date(#IST_YMD_FROM#, 'yyyy-MM-dd'), 'yyyyMMdd'), '10000101')
        </isNotEmpty>

        <isNotEmpty prepend="AND" property="IST_YMD_TO">
          A.IST_YMD <![CDATA[<=]]> decode(length(#IST_YMD_TO#), 10, to_char(to_date(#IST_YMD_TO#, 'yyyy-MM-dd'), 'yyyyMMdd'), '30000101')
        </isNotEmpty>

        <isNotEmpty prepend="AND" property="MOP_CDE">
          A.MOP_CDE like #MOP_CDE# || '%'
        </isNotEmpty>

        <isNotEmpty prepend="AND" property="JHT_CDE">
          A.JHT_CDE like #JHT_CDE# || '%'
        </isNotEmpty>

        <isNotEmpty prepend="AND" property="PIP_DIP">
          A.PIP_DIP like #PIP_DIP# || '%'
        </isNotEmpty>
      )

      SELECT C.ROWCNT, X.*  FROM (

      SELECT ROW_NUMBER() OVER( ORDER BY A.FTR_IDN DESC ) AS RN
      , A.FTR_CDE	,F.FTR_NAM
      , A.FTR_IDN
      , A.HJD_CDE	,H.HJD_NAM
      , A.SHT_NUM
      , A.MNG_CDE	,C.NM AS MNG_NAM
      , A.IST_YMD
      , A.SAA_CDE
      , A.MOP_CDE	,C3.NM AS MOP_NAM
      , A.JHT_CDE	,C2.NM AS JHT_NAM
      , A.LOW_DEP
      , A.HGH_DEP
      , A.CNT_NUM
      , A.SYS_CHK
      , A.PIP_LBL
      , A.PIP_DIP	/*구경*/
      , A.PIP_LEN
      , CASE WHEN ST_ISVALID(A.GEOM) = 1 THEN 'Y' ELSE 'N' END AS IS_GEOMETRY
      FROM INFOFMS.WTL_PIPE_LM A
      LEFT JOIN INFOFMS.V_FTR_CDE F ON A.FTR_CDE = F.FTR_CDE
      LEFT JOIN INFOFMS.BML_HADM_AS H ON A.HJD_CDE = H.HJD_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C ON C.MST_CD = (SELECT MST_CD FROM INFOUSER.CD_MST_INFO WHERE ETC = 'MNG_CDE') AND C.DTL_CD = A.MNG_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C2 ON C2.MST_CD = (SELECT MST_CD FROM INFOUSER.CD_MST_INFO WHERE ETC = 'JHT_CDE') AND C2.DTL_CD = A.JHT_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C3 ON C3.MST_CD = '250102' AND C3.DTL_CD = A.MOP_CDE

      WHERE 1=1
      <isNotEmpty prepend="AND" property="MNG_CDE">
        A.MNG_CDE like #MNG_CDE# || '%'
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="FTR_IDN">
        A.FTR_IDN like #FTR_IDN# || '%'
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="HJD_CDE">
        A.HJD_CDE like #HJD_CDE# || '%'
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="CNT_NUM">
        A.CNT_NUM like #CNT_NUM#  || '%'
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="SHT_NUM">
        A.SHT_NUM like #SHT_NUM#  || '%'
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="IST_YMD_FROM">
        A.IST_YMD <![CDATA[>=]]> decode(length(#IST_YMD_FROM#), 10, to_char(to_date(#IST_YMD_FROM#, 'yyyy-MM-dd'), 'yyyyMMdd'), '10000101')
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="IST_YMD_TO">
        A.IST_YMD <![CDATA[<=]]> decode(length(#IST_YMD_TO#), 10, to_char(to_date(#IST_YMD_TO#, 'yyyy-MM-dd'), 'yyyyMMdd'), '30000101')
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="MOP_CDE">
        A.MOP_CDE like #MOP_CDE# || '%'
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="JHT_CDE">
        A.JHT_CDE like #JHT_CDE# || '%'
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="PIP_DIP">
        A.PIP_DIP like #PIP_DIP# || '%'
      </isNotEmpty>


      ) X JOIN C ON 1=1
      WHERE RN &lt;= ($page$+1) * $rows$
      AND RN &gt;= ($page$) * $rows$ + 1

    </select>



    <!--상수관로 상세-->
    <select id ="SelectWtlPipeDtl" parameterClass="Hashtable" resultClass ="Hashtable">
      /* SelectWtlPipeList 상수관로 상세*/
      SELECT A.FTR_CDE	,F.FTR_NAM
      , A.FTR_IDN
      , A.HJD_CDE,	H.HJD_NAM
      , A.SHT_NUM
      , A.MNG_CDE	,C.NM AS MNG_NAM
      , decode(length(nvl(IST_YMD, '')), 8, to_char(to_date(IST_YMD, 'yyyyMMdd'), 'yyyy-MM-dd'), '') AS IST_YMD
      , A.SAA_CDE	,C2.NM AS SAA_NAM
      , A.MOP_CDE	,C3.NM AS MOP_NAM
      , A.JHT_CDE	,C4.NM AS JHT_NAM
      , A.LOW_DEP
      , A.HGH_DEP
      , A.CNT_NUM
      , A.SYS_CHK
      , decode(SYS_CHK,'1','유','무') as SYS_CHK_NAM
      , A.PIP_LBL
      , A.PIP_DIP
      , A.PIP_LEN
      FROM INFOFMS.WTL_PIPE_LM A
      LEFT JOIN INFOFMS.V_FTR_CDE F ON A.FTR_CDE = F.FTR_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C ON C.DTL_CD LIKE 'MNG%' AND C.DTL_CD = A.MNG_CDE
      LEFT JOIN INFOFMS.CMT_ADAR_MA H ON H.HJD_CDE = A.HJD_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C2 ON C2.DTL_CD LIKE 'SAA%' AND C2.DTL_CD = A.SAA_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C3 ON C3.DTL_CD LIKE 'MOP%' AND C3.MST_CD = '250102' AND C3.DTL_CD = A.MOP_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C4 ON C4.DTL_CD LIKE 'JHT%' AND C4.DTL_CD = A.JHT_CDE
      WHERE 1=1
      AND a.FTR_CDE = #FTR_CDE#
      AND a.FTR_IDN = #FTR_IDN#
    </select>  
    
        
    <!--상수관로 상세 클래스-->
    <select id ="SelectWtlPipeDtl2" parameterClass="Hashtable" resultClass ="GTI.WFMS.Models.Pipe.Model.PipeDtl">
      /* SelectWtlPipeList 상수관로 상세 클래스*/
      SELECT A.FTR_CDE	,F.FTR_NAM
      , A.FTR_IDN
      , A.HJD_CDE,	H.HJD_NAM
      , A.SHT_NUM
      , A.MNG_CDE	,C.NM AS MNG_NAM
      , decode(length(nvl(IST_YMD, '')), 8, to_char(to_date(IST_YMD, 'yyyyMMdd'), 'yyyy-MM-dd'), '') AS IST_YMD
      , A.SAA_CDE	,C2.NM AS SAA_NAM
      , A.MOP_CDE	,C3.NM AS MOP_NAM
      , A.JHT_CDE	,C4.NM AS JHT_NAM
      , A.LOW_DEP
      , A.HGH_DEP
      , A.CNT_NUM
      , A.SYS_CHK
      , decode(SYS_CHK,'1','유','무') as SYS_CHK_NAM
      , A.PIP_LBL
      , A.PIP_DIP
      , A.PIP_LEN
      FROM INFOFMS.WTL_PIPE_LM A
      LEFT JOIN INFOFMS.V_FTR_CDE F ON A.FTR_CDE = F.FTR_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C ON C.DTL_CD LIKE 'MNG%' AND C.DTL_CD = A.MNG_CDE
      LEFT JOIN INFOFMS.CMT_ADAR_MA H ON H.HJD_CDE = A.HJD_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C2 ON C2.DTL_CD LIKE 'SAA%' AND C2.DTL_CD = A.SAA_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C3 ON C3.DTL_CD LIKE 'MOP%' AND C3.MST_CD = '250102' AND C3.DTL_CD = A.MOP_CDE
      LEFT JOIN INFOUSER.CD_DTL_INFO C4 ON C4.DTL_CD LIKE 'JHT%' AND C4.DTL_CD = A.JHT_CDE
      WHERE 1=1
      AND a.FTR_CDE = #FTR_CDE#
      AND a.FTR_IDN = #FTR_IDN#
    </select>


    <!--상수관로 상세저장-->
    <update id="saveWtlPipeDtl" parameterClass="GTI.WFMS.Models.Pipe.Model.PipeDtl">
      /* 상수관로 상세저장 */
      UPDATE WTL_PIPE_LM
      SET HJD_CDE=#HJD_CDE#
      , SHT_NUM=#SHT_NUM#
      , MNG_CDE=#MNG_CDE#
      , IST_YMD=decode(length(#IST_YMD#), 10, to_char(to_date(#IST_YMD#, 'yyyy-MM-dd'), 'yyyyMMdd'), '')
      , SAA_CDE=#SAA_CDE#
      , JHT_CDE=#JHT_CDE#
      , MOP_CDE=#MOP_CDE#
      , LOW_DEP=#LOW_DEP#
      , HGH_DEP=#HGH_DEP#
      , CNT_NUM=#CNT_NUM#
      , SYS_CHK=#SYS_CHK#
      , PIP_LBL=#PIP_LBL#
      , PIP_DIP=#PIP_DIP#
      , PIP_LEN=#PIP_LEN#
      WHERE 	FTR_CDE = #FTR_CDE#
      AND		FTR_IDN = #FTR_IDN#
    </update>

    
    
    <!--상수관로 상세삭제-->
    <update id="deleteWtlPipeDtl" parameterClass="GTI.WFMS.Models.Pipe.Model.PipeDtl">
      /* 상수관로 상세저장 */
      DELETE WTL_PIPE_LM
      WHERE 	FTR_CDE = #FTR_CDE#
      AND		FTR_IDN = #FTR_IDN#
    </update>

    <!--상수관로 관리번호 채번-->
    <select id ="SelectWtlPipeFTR_IDN" parameterClass="Hashtable" resultClass ="GTI.WFMS.Models.Pipe.Model.PipeDtl">
      SELECT NVL(MAX(FTR_IDN),0)+1 AS FTR_IDN FROM INFOFMS.WTL_PIPE_LM WHERE 1=1
      AND FTR_CDE = #FTR_CDE#
    </select>

      <!--상수관로 상세추가-->
    <update id="insertWtlPipeDtl" parameterClass="GTI.WFMS.Models.Pipe.Model.PipeDtl">
      INSERT INTO WTL_PIPE_LM
      ( FTR_CDE
      , FTR_IDN
      , HJD_CDE
      , SHT_NUM
      , MNG_CDE
      , IST_YMD
      , SAA_CDE
      , MOP_CDE
      , JHT_CDE
      , LOW_DEP
      , HGH_DEP
      , CNT_NUM
      , SYS_CHK
      , PIP_LBL
      , PIP_DIP
      , PIP_LEN )
      
      VALUES (#FTR_CDE#
      , #FTR_IDN#
      , #HJD_CDE#
      , #SHT_NUM#
      , #MNG_CDE#
      , decode(length(#IST_YMD#), 10, to_char(to_date(#IST_YMD#, 'yyyy-MM-dd'), 'yyyyMMdd'), '')
      , #SAA_CDE#
      , #MOP_CDE#
      , #JHT_CDE#
      , #LOW_DEP#
      , #HGH_DEP#
      , #CNT_NUM#
      , #SYS_CHK#
      , #PIP_LBL#
      , #PIP_DIP#
      , #PIP_LEN# )
    </update>




  </statements>
  
</sqlMap>