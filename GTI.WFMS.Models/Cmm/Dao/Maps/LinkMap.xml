<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Main" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://ibatis.apache.org/mapping">
  <statements>
    
    <!--유지보수상세내역-->
    <select id="selectChscResSubList" resultClass="GTI.WFMS.Models.Cmm.Model.LinkFmsChscFtrRes">
      /* selectChscResSubList - 유지보수(점검시설 결과) */
      SELECT ROWNUM AS RNO
           , M.*
        FROM (
              SELECT
                    A.SCL_NUM
                  , A.FTR_CDE, F.FTR_NAM
                  , A.FTR_IDN
                  , A.RPR_YMD
                  , decode(length(A.RPR_YMD), 8, to_char(to_date(A.RPR_YMD, 'yyyyMMdd'), 'yyyy-MM-dd'), '') AS RPR_YMD_FMT
                  , A.RPR_CAT_CDE   /*보수구분*/
                  , C.NM AS RPR_CAT_NAM
                  , A.RPR_CUZ_CDE   /*보수사유*/
                  , C2.NM AS RPR_CUZ_NAM
                  , A.RPR_USR_NM    /*시공자명*/
                  , A.RPR_CTNT      /*보수내용*/
                  , A.FIL_SEQ
              FROM FMS_CHSC_FTR_RES A
                   LEFT JOIN INFOFMS.V_FTR_CDE F ON A.FTR_CDE = F.FTR_CDE
                   LEFT JOIN INFOUSER.CD_DTL_INFO C ON C.MST_CD = (SELECT MST_CD FROM INFOUSER.CD_MST_INFO WHERE ETC = 'RPR_CAT_CDE') AND C.DTL_CD = A.RPR_CAT_CDE
                   LEFT JOIN INFOUSER.CD_DTL_INFO C2 ON C2.MST_CD = (SELECT MST_CD FROM INFOUSER.CD_MST_INFO WHERE ETC = 'RPR_CUZ_CDE') AND C2.DTL_CD = A.RPR_CUZ_CDE
              WHERE 1=1
              <!-- 조건1. 지형지물 -->
              <isNotEmpty prepend="AND" property="FTR_CDE">
                A.FTR_CDE = #FTR_CDE#
              </isNotEmpty>
              <!-- 조건2. 관리번호 -->
              <isNotEmpty prepend="AND" property="FTR_IDN">
                A.FTR_IDN = #FTR_IDN#
              </isNotEmpty>
            ORDER BY A.FTR_CDE, A.FTR_IDN, A.RPR_YMD DESC
      )  M
    </select>

    

    <select id="selectWtlLeakSubList" resultClass="GTI.WFMS.Models.Cmm.Model.LinkWtlLeakPs">
      /* selectWtlLeakSubList - 누수지점 서브 목록 화면 */
      SELECT ROWNUM AS RNO
           , M.*
       FROM (SELECT A.FTR_CDE
                  , (SELECT FTR_NAM FROM INFOFMS.V_FTR_CDE WHERE FTR_CDE = A.FTR_CDE) AS FTR_NAM
                  , A.FTR_IDN
                  , A.HJD_CDE
                  , (SELECT HJD_NAM FROM INFOFMS.CMT_ADAR_MA WHERE HJD_CDE = A.HJD_CDE) AS HJD_NAM
                  , A.SHT_NUM
                  , A.RCV_NUM
                  , decode(length(LEK_YMD), 8, to_char(to_date(LEK_YMD, 'yyyyMMdd'), 'yyyy-MM-dd'), '') AS LEK_YMD
                  , A.LEK_LOC
                  , A.PIP_CDE
                  , A.PIP_IDN
                  , A.LRS_CDE
                  , A.LEP_CDE
                  , A.REP_YMD
                  , A.REP_EXP
                  , A.MAT_DES
                  , A.REP_NAM
                  , A.SYS_CHK
                  , A.LEK_EXP
                  , A.MOP_CDE
                  , A.PIP_DIP	/*관구경*/
                FROM WTL_LEAK_PS A
               WHERE 1=1
                 AND A.FTR_CDE = #FTR_CDE#
                 AND A.FTR_IDN = #FTR_IDN#
               ORDER BY  A.FTR_CDE DESC , A.FTR_IDN DESC
            ) M
    </select>


    <!--부속시설 세부현황 조회-->
    <select id="SelectCmmWttAttaDt" resultClass="GTI.WFMS.Models.Fctl.Model.WttAttaDt">
      SELECT ROWNUM AS RNO, M.*
        FROM (SELECT A.ATT_IDN
                   , A.FTR_CDE	
                   , F.FTR_NAM
                   , A.FTR_IDN
                   , A.ATT_NAM
                   , A.ATT_DES
                   , A.ATTA_SEQ
                   , A.CRE_YY
                FROM WTT_ATTA_DT A
                     LEFT JOIN INFOFMS.V_FTR_CDE F ON A.FTR_CDE = F.FTR_CDE
               WHERE 1=1
                 AND A.FTR_CDE=#FTR_CDE#
                 AND A.FTR_IDN=#FTR_IDN#
              <isNotEmpty prepend="AND" property="ATTA_SEQ">
                A.ATTA_SEQ = #ATTA_SEQ#
              </isNotEmpty>
              <isNotEmpty prepend="AND" property="ATT_IDN">
                A.ATT_IDN like #ATT_IDN# || '%'
              </isNotEmpty>
              ORDER BY A.ATT_IDN DESC
            ) M
    </select>

    
    <!-- 부속시설 저장 -->
    <update id="SaveWttAttaDt" parameterClass="GTI.WFMS.Models.Fctl.Model.WttAttaDt">
      MERGE INTO WTT_ATTA_DT
      USING DUAL ON ( FTR_CDE=#FTR_CDE# AND FTR_IDN=#FTR_IDN# AND ATTA_SEQ=#ATTA_SEQ#  )

      WHEN MATCHED THEN

      UPDATE
      SET ATT_IDN=#ATT_IDN#
      , ATT_NAM=#ATT_NAM#
      , ATT_DES=#ATT_DES#
      , CRE_YY = #CRE_YY#

      WHEN NOT MATCHED THEN
      INSERT
      ( FTR_CDE
      , FTR_IDN
      , ATTA_SEQ
      , ATT_IDN
      , ATT_NAM
      , ATT_DES
      , CRE_YY
      )
      VALUES ( #FTR_CDE#
      , #FTR_IDN#
      , (SELECT NVL(MAX(ATTA_SEQ),0)+1 as ATTA_SEQ FROM WTT_ATTA_DT )
      , #ATT_IDN#
      , #ATT_NAM#
      , #ATT_DES#
      , #CRE_YY#
      )
    </update>


    <!-- 부속시설 저장 -->
    <update id="DeleteWttAttaDt" parameterClass="GTI.WFMS.Models.Fctl.Model.WttAttaDt">
      DELETE FROM WTT_ATTA_DT WHERE 1=1
      AND FTR_CDE=#FTR_CDE# 
      AND FTR_IDN=#FTR_IDN# 
      AND ATTA_SEQ=#ATTA_SEQ#
    </update>



    <!--시설물전체조회-->
    <select id ="SelectFtrAllList" parameterClass="Hashtable" resultClass ="Hashtable">

      WITH C AS (
      SELECT COUNT(1) AS ROWCNT
            
              FROM V_FTR F
              LEFT JOIN V_FTR_CDE D ON D.FTR_CDE = F.FTR_CDE
              LEFT JOIN CMT_ADAR_MA H ON H.HJD_CDE = F.HJD_CDE
              LEFT JOIN WTT_CONS_MA C ON C.CNT_NUM = F.CNT_NUM
              WHERE 1=1

              <isNotEmpty prepend="AND" property="FTR_IDN">
                F.FTR_IDN = #FTR_IDN#
              </isNotEmpty>
              <isNotEmpty prepend="AND" property="FTR_CDE">
                F.FTR_CDE = #FTR_CDE#
              </isNotEmpty>
              <isNotEmpty prepend="AND" property="FTR_NAM">
                D.FTR_NAM LIKE '%' || #FTR_NAM# || '%'
              </isNotEmpty>
              <isNotEmpty prepend="AND" property="CNT_NUM">
                F.CNT_NUM = #CNT_NUM#
              </isNotEmpty>
              <isNotEmpty prepend="AND" property="CNT_NAM">
                C.CNT_NAM LIKE '%' || #CNT_NAM# || '%'
              </isNotEmpty>
              <isNotEmpty prepend="AND" property="HJD_CDE">
                F.HJD_CDE = #HJD_CDE#
              </isNotEmpty>

      )

      SELECT C.ROWCNT, X.*  FROM (

      SELECT ROW_NUMBER() OVER( ORDER BY F.FTR_CDE, F.FTR_IDN ) AS RN
      , F.FTR_IDN
      , F.FTR_CDE, D.FTR_NAM
      , F.HJD_CDE, H.HJD_NAM
      , F.CNT_NUM, C.CNT_NAM
      , F.TAB
      , null AS CHK

      FROM V_FTR F
      LEFT JOIN V_FTR_CDE D ON D.FTR_CDE = F.FTR_CDE
      LEFT JOIN CMT_ADAR_MA H ON H.HJD_CDE = F.HJD_CDE
      LEFT JOIN WTT_CONS_MA C ON C.CNT_NUM = F.CNT_NUM
      WHERE 1=1

      <isNotEmpty prepend="AND" property="FTR_IDN">
              F.FTR_IDN = #FTR_IDN#
            </isNotEmpty>
            <isNotEmpty prepend="AND" property="FTR_CDE">
              F.FTR_CDE = #FTR_CDE#
            </isNotEmpty>
            <isNotEmpty prepend="AND" property="FTR_NAM">
              D.FTR_NAM LIKE '%' || #FTR_NAM# || '%'
            </isNotEmpty>
            <isNotEmpty prepend="AND" property="CNT_NUM">
              F.CNT_NUM = #CNT_NUM#
            </isNotEmpty>
            <isNotEmpty prepend="AND" property="CNT_NAM">
              C.CNT_NAM LIKE '%' || #CNT_NAM# || '%'
            </isNotEmpty>
            <isNotEmpty prepend="AND" property="HJD_CDE">
              F.HJD_CDE = #HJD_CDE#
            </isNotEmpty>

      ) X JOIN C ON 1=1
      WHERE RN &lt;= ($page$+1) * $rows$
      AND RN &gt;= ($page$) * $rows$ + 1

    </select>




  </statements>
</sqlMap>