<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Main" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://ibatis.apache.org/mapping">
  <statements>

    <!--점검목록-->
    <select id="SelectChscMaList"  resultClass="GTI.WFMS.Models.Mntc.Model.ChscMaDtl">
      SELECT A.SCL_NUM
      , A.SCL_CDE
      , C2.NM AS SCL_NM
      , A.SCL_STAT_CDE
      , nvl(C.NM,'점검등록') AS SCL_STAT_NM

      , case when A.SCL_STAT_CDE = 'SCL_STAT_CDE01' then '35495f'
      when A.SCL_STAT_CDE = 'SCL_STAT_CDE02' then '3b81cb'
      when A.SCL_STAT_CDE = 'SCL_STAT_CDE03' then 'fd7e02'
      else '35495f' end AS COLOR

      , A.MNG_CDE, A.TIT_NAM
      , A.STA_YMD
      , A.END_YMD
      , A.CKM_GRP_NM, A.CKM_PEO, A.CHK_CTNT
      ,case when length(A.CHK_APR_YMD) = 8 then substr(A.CHK_APR_YMD,1,4) || '-' || substr(A.CHK_APR_YMD,5,2) || '-' || substr(A.CHK_APR_YMD,7,2) else '' end  as CHK_APR_YMD
      ,case when length(A.CHK_APR_USR) = 8 then substr(A.CHK_APR_USR,1,4) || '-' || substr(A.CHK_APR_USR,5,2) || '-' || substr(A.CHK_APR_USR,7,2) else '' end  as CHK_APR_USR
      ,case when length(A.CHK_CMP_YMD) = 8 then substr(A.CHK_CMP_YMD,1,4) || '-' || substr(A.CHK_CMP_YMD,5,2) || '-' || substr(A.CHK_CMP_YMD,7,2) else '' end  as CHK_CMP_YMD
      ,case when length(A.CHK_RESULT_YMD) = 8 then substr(A.CHK_RESULT_YMD,1,4) || '-' || substr(A.CHK_RESULT_YMD,5,2) || '-' || substr(A.CHK_RESULT_YMD,7,2) else '' end  as CHK_RESULT_YMD
      , U.USER_NM
      , to_char(A.CRE_YMD,'yyyy-mm-dd') CRE_YMD
      , A.CRE_USR
      , to_char(A.UPD_YMD,'yyyy-mm-dd') UPD_YMD
      , A.UPD_USR

      FROM FMS_CHSC_MA A
      LEFT JOIN INFOUSER.CD_DTL_INFO C ON A.SCL_STAT_CDE = C.DTL_CD AND C.ETC LIKE 'SCL_STAT_CDE'
      LEFT JOIN INFOUSER.CD_DTL_INFO C2 ON A.SCL_CDE = C2.DTL_CD AND C2.ETC LIKE 'SCL_CDE'
      LEFT JOIN INFOUSER.SYS_USER_INFO U ON A.CRE_USR = U.USER_ID
      WHERE 1=1
      <isNotEmpty prepend="AND" property="MNG_CDE">
        A.MNG_CDE LIKE #MNG_CDE#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SCL_CDE">
        A.SCL_CDE LIKE #SCL_CDE#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SCL_STAT_CDE">
        A.SCL_STAT_CDE LIKE #SCL_STAT_CDE#
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="TIT_NAM">
        A.TIT_NAM LIKE '%' || #TIT_NAM# || '%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="CKM_PEO">
        A.CKM_PEO LIKE '%' || #CKM_PEO# || '%'
      </isNotEmpty>

      <isNotEmpty prepend="AND" property="STA_YMD">
        A.STA_YMD <![CDATA[>=]]> TO_CHAR(TO_DATE(#STA_YMD#, 'yyyy-MM-dd'), 'yyyyMMdd')
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="END_YMD">
        A.END_YMD <![CDATA[<=]]> TO_CHAR(TO_DATE(#END_YMD#, 'yyyy-MM-dd'), 'yyyyMMdd')
      </isNotEmpty>


    </select>

    <!--점검일정 저장-->
    <update id="SaveChscMaDtl" parameterClass="GTI.WFMS.Models.Mntc.Model.ChscMaDtl">
      MERGE INTO FMS_CHSC_MA
      USING DUAL ON ( SCL_NUM=#SCL_NUM#)

      WHEN MATCHED THEN
      UPDATE
      SET
      UPD_YMD = sysdate
      ,UPD_USR = #ID#
      <isNotEmpty property="SCL_STAT_CDE">
        ,SCL_STAT_CDE = #SCL_STAT_CDE#
      </isNotEmpty>
      <isNotEmpty property="MNG_CDE">
        ,MNG_CDE = #MNG_CDE#
      </isNotEmpty>
      <isNotEmpty property="TIT_NAM">
        ,TIT_NAM = #TIT_NAM#
      </isNotEmpty>
      <isNotEmpty property="STA_YMD">
        ,STA_YMD = #STA_YMD#
      </isNotEmpty>
      <isNotEmpty property="END_YMD">
        ,END_YMD = #END_YMD#
      </isNotEmpty>
      <isNotEmpty property="CKM_GRP_NM">
        ,CKM_GRP_NM = #CKM_GRP_NM#
      </isNotEmpty>
      <isNotEmpty property="CKM_PEO">
        ,CKM_PEO = #CKM_PEO#
      </isNotEmpty>
      <isNotEmpty property="CHK_CTNT">
        ,CHK_CTNT = #CHK_CTNT#
      </isNotEmpty>
      <isNotEmpty property="CHK_APR_YMD">
        ,CHK_APR_YMD = decode(length(#CHK_APR_YMD#), 10, to_char(to_date(#CHK_APR_YMD#, 'yyyy-MM-dd'), 'yyyyMMdd'), '')
      </isNotEmpty>
      <isNotEmpty property="CHK_APR_USR">
        ,CHK_APR_USR = #CHK_APR_USR#
      </isNotEmpty>
      <isNotEmpty property="CHK_CMP_YMD">
        ,CHK_CMP_YMD = decode(length(#CHK_CMP_YMD#), 10, to_char(to_date(#CHK_CMP_YMD#, 'yyyy-MM-dd'), 'yyyyMMdd'), '')
      </isNotEmpty>
      <isNotEmpty property="CHK_RESULT_YMD">
        ,CHK_RESULT_YMD = #CHK_RESULT_YMD#
      </isNotEmpty>

      WHEN NOT MATCHED THEN
      Insert (SCL_NUM, SCL_CDE,SCL_STAT_CDE,MNG_CDE,TIT_NAM,STA_YMD,END_YMD,CKM_GRP_NM,CKM_PEO
      ,CHK_CTNT,CHK_APR_YMD,CHK_APR_USR,CHK_CMP_YMD,CHK_RESULT_YMD,CRE_YMD,CRE_USR,UPD_YMD,UPD_USR)
      values(
      (select nvl(max(SCL_NUM),0)+1 from FMS_CHSC_MA)
      , #SCL_CDE#,	'SCL_STAT_CDE01', #MNG_CDE#, #TIT_NAM#
      , #STA_YMD#
      , #END_YMD#
      , #CKM_GRP_NM#
      , #CKM_PEO#, #CHK_CTNT#
      , decode(length(#CHK_APR_YMD#), 10, to_char(to_date(#CHK_APR_YMD#, 'yyyy-MM-dd'), 'yyyyMMdd'), '')
      , #CHK_APR_USR#
      , decode(length(#CHK_CMP_YMD#), 10, to_char(to_date(#CHK_CMP_YMD#, 'yyyy-MM-dd'), 'yyyyMMdd'), '')
      , #CHK_RESULT_YMD#
      , sysdate, #ID#, sysdate, #ID#)
    </update>


    <!--점검일정 삭제-->
    <update id="DeleteChscMaDtl" parameterClass="GTI.WFMS.Models.Mntc.Model.ChscMaDtl">
      DELETE FROM FMS_CHSC_MA
      WHERE SCL_NUM=#SCL_NUM#
    </update>






    <!-- 점검결과리스트-->
    <select id="SelectChscResultList"  resultClass="Hashtable">
      SELECT R.SCL_NUM
      , R.FTR_CDE, R.FTR_IDN, R.SEQ
      , VN.FTR_NAM
      , R.RPR_YMD
      , R.RPR_CAT_CDE, C.CD_NM RPR_CAT_NM
      , R.RPR_CUZ_CDE, C2.CD_NM RPR_CUZ_NM
      , R.RPR_USR_NM, R.RPR_CTNT
      , V.HJD_CDE, H.HJD_NAM
      , R.FIL_SEQ
      , F.FIL_NM
      , NULL AS CHK
      FROM FMS_CHSC_FTR_RES R
      LEFT JOIN V_FTR V ON R.FTR_CDE = V.FTR_CDE AND R.FTR_IDN = V.FTR_IDN
      LEFT JOIN V_FTR_CDE VN ON R.FTR_CDE = VN.FTR_CDE
      LEFT JOIN CMT_ADAR_MA H ON H.HJD_CDE = V.HJD_CDE
      LEFT JOIN CD_DTL_INFO C ON R.RPR_CAT_CDE = C.DTL_CD
      LEFT JOIN CD_DTL_INFO C2 ON R.RPR_CUZ_CDE = C.DTL_CD
      LEFT JOIN FMS_FILE_MST F ON F.FIL_SEQ = R.FIL_SEQ
      WHERE R.SCL_NUM = #SCL_NUM#
      ORDER BY R.CRE_YMD, R.FTR_CDE, R.FTR_IDN, R.SEQ

    </select>


    <!-- 점검결과 상세 리스트 저장 -->
    <update id="SaveChscResult" parameterClass="Hashtable">
      MERGE INTO FMS_CHSC_FTR_RES
      USING DUAL ON ( SCL_NUM=#SCL_NUM# AND FTR_CDE=#FTR_CDE# AND FTR_IDN=#FTR_IDN# AND SEQ = #SEQ# )

      WHEN MATCHED THEN

      UPDATE  SET
      RPR_YMD			= replace(#RPR_YMD#,'-','')
      ,RPR_CAT_CDE	= #RPR_CAT_CDE#
      ,RPR_CUZ_CDE    = #RPR_CUZ_CDE#
      ,RPR_USR_NM     = #RPR_USR_NM#
      ,RPR_CTNT       = #RPR_CTNT#
      ,FIL_SEQ       = #FIL_SEQ#
      ,UPD_YMD        = sysdate
      ,UPD_USR        = #ID#

      WHEN NOT MATCHED THEN
      INSERT
      ( SCL_NUM
      , FTR_CDE
      , FTR_IDN
      , SEQ
      , RPR_YMD
      , RPR_CAT_CDE
      , RPR_CUZ_CDE
      , RPR_USR_NM
      , RPR_CTNT
      , FIL_SEQ
      , CRE_YMD
      , CRE_USR
      , UPD_YMD
      , UPD_USR
      )
      VALUES (
      #SCL_NUM#, #FTR_CDE#, #FTR_IDN#, (select nvl(max(SEQ),0)+1 from FMS_CHSC_FTR_RES where SCL_NUM=#SCL_NUM# AND FTR_CDE=#FTR_CDE# AND FTR_IDN=#FTR_IDN# )
      , replace(#RPR_YMD#,'-',''), #RPR_CAT_CDE#, #RPR_CUZ_CDE#, #RPR_USR_NM#, #RPR_CTNT#, #FIL_SEQ#
      , sysdate, #ID#, sysdate, #ID#
      )


    </update>    

    <!-- 점검결과 상세 삭제 -->
    <update id="DeleteChscResult" parameterClass="Hashtable">
      DELETE FMS_CHSC_FTR_RES
      WHERE 1=1
      AND SCL_NUM=#SCL_NUM#
      AND FTR_CDE=#FTR_CDE#
      AND FTR_IDN=#FTR_IDN#
      AND SEQ = #SEQ#
    </update>
    

    <!-- 소모품 사용내역 리스트 -->
    <select id="SelectPdhUseList"  resultClass="Hashtable">
      SELECT H.PDH_HT_NUM, H.PDH_NUM, H.FTR_CDE, H.FTR_IDN, H.SCL_NUM, H.SEQ
      , H.PDH_CNT, H.PDH_AMT
      , P.PDT_NAM
      , P.PDT_MDL_STD
      
      FROM FMS_PDJT_HT H
      INNER JOIN FMS_PDJT_MA P ON P.PDH_NUM = H.PDH_NUM
      WHERE 1=1
      AND H.SCL_NUM =#SCL_NUM# 
      AND H.FTR_CDE = #FTR_CDE# 
      AND H.FTR_IDN = #FTR_IDN# 
      AND H.SEQ = #SEQ#
      AND P.PDT_CAT_CDE = #PDT_CAT_CDE#
      ORDER BY H.PDH_HT_NUM
    </select>

    <!-- 소모품내역 삭제 -->
    <update id="DeletePdjtHt" parameterClass="Hashtable">
      DELETE FROM FMS_PDJT_HT
      WHERE 1=1
      AND SCL_NUM=#SCL_NUM#
      AND FTR_CDE=#FTR_CDE#
      AND FTR_IDN=#FTR_IDN#
      AND SEQ = #SEQ#
      AND PDH_HT_NUM = #PDH_HT_NUM#
    </update>


    <!-- 소모품/오일 저장 -->
    <update id="SavePdjtHt" parameterClass="Hashtable">
      MERGE INTO FMS_PDJT_HT
      USING DUAL ON ( PDH_HT_NUM = #PDH_HT_NUM# AND PDH_NUM = #PDH_NUM#  AND SCL_NUM=#SCL_NUM# AND FTR_CDE=#FTR_CDE# AND FTR_IDN=#FTR_IDN# AND SEQ = #SEQ#)

      WHEN MATCHED THEN

      UPDATE  SET
      PDH_CNT = #PDH_CNT#
      , PDH_AMT = #PDH_AMT#
      ,UPD_YMD = sysdate
      ,UPD_USR = #ID#

      WHEN NOT MATCHED THEN
      INSERT
      ( PDH_HT_NUM
      , PDH_NUM, FTR_CDE, FTR_IDN, SCL_NUM, SEQ
      , PDH_CNT, PDH_AMT, CRE_YMD, CRE_USR, UPD_YMD, UPD_USR)
      VALUES (
      (select nvl(max(PDH_HT_NUM),0)+1 from FMS_PDJT_HT)
      , #PDH_NUM#, #FTR_CDE#, #FTR_IDN#, #SCL_NUM#, #SEQ#
      , #PDH_CNT#, #PDH_AMT#
      , sysdate, #ID#, sysdate, #ID#
      )
    </update>


    <!-- 소모품 코드-->
    <select id="SelectPdhList"  resultClass="Hashtable">
      SELECT PDH_NUM, PDT_CAT_CDE, PDT_NAM, PDE_NAM, PDT_MDL_STD, PDT_MNF, PDT_MDL, PDT_UNT
      FROM FMS_PDJT_MA
      WHERE 1=1
      AND PDT_CAT_CDE = #PDT_CAT_CDE#
      AND USE_YN != 'N'
    </select>


  </statements>
  
</sqlMap>